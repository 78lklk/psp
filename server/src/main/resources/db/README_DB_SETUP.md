# Настройка базы данных для системы лояльности

## Быстрая инициализация

### 1. Подключение к PostgreSQL

```bash
# Подключение к серверу PostgreSQL (от имени superuser)
psql -U postgres -h localhost
```

### 2. Создание базы данных

```sql
-- Создание базы данных
CREATE DATABASE loyalty_db;

-- Подключение к созданной базе данных
\c loyalty_db;
```

### 3. Выполнение скрипта инициализации

```sql
-- Выполнение полного скрипта инициализации
\i init_full_database.sql;
```

## Альтернативный способ (из командной строки)

```bash
# Создание базы данных
createdb -U postgres loyalty_db

# Выполнение скрипта инициализации
psql -U postgres -d loyalty_db -f init_full_database.sql
```

## Конфигурация приложения

После создания базы данных обновите настройки подключения в файле:
`server/src/main/resources/config.properties`

```properties
# Настройки базы данных
db.host=localhost
db.port=5432
db.name=loyalty_db
db.user=postgres
db.password=ваш_пароль
```

## Учетные записи по умолчанию

После инициализации будут созданы следующие пользователи:

### Администраторы:

- **Логин:** `admin` | **Пароль:** `admin123` | **Роль:** ADMIN
- **Логин:** `manager` | **Пароль:** `manager123` | **Роль:** MANAGER

### Сотрудники:

- **Логин:** `staff1` | **Пароль:** `staff123` | **Роль:** STAFF
- **Логин:** `staff2` | **Пароль:** `staff123` | **Роль:** STAFF

### Клиенты:

- **Логин:** `client1` | **Пароль:** `password123` | **Роль:** CLIENT
- **Логин:** `client2` | **Пароль:** `password123` | **Роль:** CLIENT
- И другие тестовые клиенты...

## Структура данных

### Основные таблицы:

- `roles` - роли пользователей
- `users` - пользователи системы
- `tiers` - уровни лояльности
- `cards` - карты клиентов
- `sessions` - игровые сессии
- `transactions` - транзакции по баллам
- `promotions` - акции
- `promo_codes` - промокоды
- `settings` - настройки системы

### Вспомогательные таблицы:

- `card_promotions` - участие карт в акциях
- `audit_log` - журнал аудита
- `backups` - информация о резервных копиях
- `report_cache` - кэш отчетов
- `offline_queue` - очередь офлайн операций

## Тестовые данные

Скрипт создает:

- 11 пользователей разных ролей
- 10 карт клиентов с разными уровнями
- 5 акций с различными условиями
- 7 промокодов
- 10 игровых сессий
- 20 транзакций
- Настройки системы по умолчанию

## Особенности

1. **Пароли в открытом виде** - все пароли хранятся без шифрования для удобства тестирования
2. **UTF-8 кодировка** - поддержка русских символов
3. **Автоматические триггеры** - автоматическое повышение уровня карты при накоплении баллов
4. **Индексы** - для быстрой работы с большими объемами данных
5. **Представления** - готовые вьюшки для отчетов и статистики

## Проверка

После выполнения скрипта вы увидите:

- Сообщение об успешной инициализации
- Статистику созданных записей
- Информацию о размере таблиц

## Сброс данных

Для полного сброса и пересоздания базы данных:

```sql
-- Удаление базы данных
DROP DATABASE IF EXISTS loyalty_db;

-- Создание заново
CREATE DATABASE loyalty_db;
\c loyalty_db;
\i init_full_database.sql;
```

## Резервное копирование

```bash
# Создание резервной копии
pg_dump -U postgres loyalty_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Восстановление из резервной копии
psql -U postgres loyalty_db < backup_файл.sql
```
